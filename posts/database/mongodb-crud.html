<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>MongoDB - 增删改查 - 程序员翔仔</title><meta name=Description content="程序员翔仔，一个记录了翔仔个人编程笔记的地方"><meta property="og:title" content="MongoDB - 增删改查"><meta property="og:description" content="对于开发人员而言，数据库的增删改查操作才是最常使用的功能，学习 MongoDB 时还需对这些功能熟记于心才行啊。我就在这里做一个简单的备忘，多看官方文档才是正道。"><meta property="og:type" content="article"><meta property="og:url" content="https://fatedeity.cn/posts/database/mongodb-crud.html"><meta property="og:image" content="https://fatedeity.cn/favicon-32x32.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-11-16T09:37:28+08:00"><meta property="article:modified_time" content="2023-01-31T11:04:30+08:00"><meta property="og:site_name" content="程序员翔仔"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://fatedeity.cn/favicon-32x32.png"><meta name=twitter:title content="MongoDB - 增删改查"><meta name=twitter:description content="对于开发人员而言，数据库的增删改查操作才是最常使用的功能，学习 MongoDB 时还需对这些功能熟记于心才行啊。我就在这里做一个简单的备忘，多看官方文档才是正道。"><meta name=application-name content="程序员翔仔"><meta name=apple-mobile-web-app-title content="程序员翔仔"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://fatedeity.cn/posts/database/mongodb-crud.html><link rel=prev href=https://fatedeity.cn/posts/database/mongodb-started-guide.html><link rel=next href=https://fatedeity.cn/posts/database/mongodb-index-knowledge.html><link rel=stylesheet href=/css/style.min.68f5de0d22e326dedf4dfe8e806e9640b9919ae9e1b50df254df92f9036a799d59ba1cff1530486374bc022352a3adb1bab3b30a35aeafa690009183d4d51c2f.css integrity="sha512-aPXeDSLjJt7fTf6OgG6WQLmRmunhtQ3yVN+S+QNqeZ1Zuhz/FTBIY3S8AiNSo62xurOzCjWur6aQAJGD1NUcLw=="><link rel=preload href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css></noscript><link rel=preload href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css></noscript><meta name=google-site-verification content="NSfr_TOb9-BVneo8k_7eO6vn7dy9XsG3KB7jBQD8hiA"><meta name=baidu-site-verification content="code-jrerrcwoiq"><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"MongoDB - 增删改查","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/fatedeity.cn\/posts\/database\/mongodb-crud.html"},"genre":"posts","keywords":"NoSQL, MongoDB","wordcount":4356,"url":"https:\/\/fatedeity.cn\/posts\/database\/mongodb-crud.html","datePublished":"2022-11-16T09:37:28+08:00","dateModified":"2023-01-31T11:04:30+08:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"翔仔"},"description":""}</script></head><body data-header-desktop=fixed data-header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title=程序员翔仔><img class="lazyload logo" src=/svg/loading.min.svg data-src=/logo-40x40.png data-srcset="/logo-40x40.png, /logo-40x40.png 1.5x, /logo-40x40.png 2x" data-sizes=auto alt=/logo-40x40.png title=/logo-40x40.png>程序员翔仔</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/>首页 </a><a class=menu-item href=/categories.html>分类 </a><a class=menu-item href=/tags.html>标签 </a><a class=menu-item href=/posts.html>归档 </a><a class=menu-item href=/about.html>关于 </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder=搜索文章标题或内容... id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=搜索><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=清空><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span>
</span><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题><i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title=程序员翔仔><img class="lazyload logo" src=/svg/loading.min.svg data-src=/logo-40x40.png data-srcset="/logo-40x40.png, /logo-40x40.png 1.5x, /logo-40x40.png 2x" data-sizes=auto alt=/logo-40x40.png title=/logo-40x40.png>程序员翔仔</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder=搜索文章标题或内容... id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=搜索><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=清空><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>取消</a></div><a class=menu-item href=/ title>首页</a><a class=menu-item href=/categories.html title>分类</a><a class=menu-item href=/tags.html title>标签</a><a class=menu-item href=/posts.html title>归档</a><a class=menu-item href=/about.html title>关于</a><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题>
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>目录</h2><div class="toc-content always-active" id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">MongoDB - 增删改查</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=/ title=Author rel=author class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>翔仔</a></span>&nbsp;<span class=post-category>收录于 <a href=/categories/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%8A%80%E6%9C%AF.html><i class="far fa-folder fa-fw" aria-hidden=true></i>数据库技术</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=2022-11-16>2022-11-16</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden=true></i>&nbsp;约 4356 字&nbsp;
<i class="far fa-clock fa-fw" aria-hidden=true></i>&nbsp;预计阅读 9 分钟&nbsp;</div></div><div class="details toc" id=toc-static data-kept><div class="details-summary toc-title"><span>目录</span>
<span><i class="details-icon fas fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#连接>连接</a><ul><li><a href=#标准-uri-连接语法>标准 URI 连接语法</a></li><li><a href=#连接选项>连接选项</a></li><li><a href=#连接命令格式>连接命令格式</a></li></ul></li><li><a href=#插入文档>插入文档</a><ul><li><a href=#插入校验>插入校验</a></li><li><a href=#单个插入>单个插入</a></li><li><a href=#批量插入>批量插入</a></li></ul></li><li><a href=#删除文档>删除文档</a><ul><li><a href=#单个删除>单个删除</a></li><li><a href=#批量删除>批量删除</a></li><li><a href=#单个删除并返回>单个删除并返回</a></li></ul></li><li><a href=#更新文档>更新文档</a><ul><li><a href=#单个更新>单个更新</a></li><li><a href=#批量更新>批量更新</a></li><li><a href=#单个替换>单个替换</a></li><li><a href=#单个更新并返回>单个更新并返回</a></li><li><a href=#单个替换并返回>单个替换并返回</a></li><li><a href=#更新运算符>更新运算符</a></li></ul></li><li><a href=#批量写操作>批量写操作</a></li><li><a href=#查询文档>查询文档</a><ul><li><a href=#单个查询>单个查询</a></li><li><a href=#批量查询>批量查询</a></li><li><a href=#查询运算符>查询运算符</a></li><li><a href=#特殊的-null-值>特殊的 null 值</a></li></ul></li></ul></nav></div></div><div class=content id=content><p>对于开发人员而言，数据库的增删改查操作才是最常使用的功能，学习 MongoDB 时还需对这些功能熟记于心才行啊。我就在这里做一个简单的备忘，多看官方文档才是正道。</p><h2 id=连接>连接</h2><h3 id=标准-uri-连接语法>标准 URI 连接语法</h3><p>通常，可以设定标准的 URI 连接语法，作为连接配置：</p><pre tabindex=0><code>mongodb://[username:password@]host1[:port1][,host2[:port2],...[,hostN[:portN]]][/[database][?options]]
</code></pre><ul><li><code>mongodb://</code>: 固定的格式，即指定当前的 URI 是标准的 MongoDB 连接语法</li><li><code>username:password@</code>: 可选项，如果设置，在连接数据库服务器之后，驱动会尝试登录这个数据库</li><li><code>host1</code>: 必须的，至少指定一个 host，它指定了要连接服务器的地址。如果要连接副本及集，需要指定多个主机地址</li><li><code>portX</code>: 可选的指定端口，如果不填，默认为 <code>27017</code></li><li><code>/database</code>: 如果指定账号和密码，连接并验证登录指定数据库。若不指定，默认打开 test 数据库</li><li><code>?options</code>: 连接选项，如果没有指定数据库，则前面需要加上 <code>/</code>。所有连接选项都是键值对 <code>name=value</code>，键值对之间通过 <code>&</code> 或 <code>;</code> 隔开</li></ul><h3 id=连接选项>连接选项</h3><p>标准的连接格式包含了多个选项，如下所示：</p><ul><li><code>replicaSet=name</code>: 验证副本集的名称</li><li><code>slaveOk=true|false</code>: 选择连接主服务器的方式<ul><li><code>true</code>: 表示有从服务器，当 <code>connect=direct</code> 时会连接第一台机器，即使这台不是主服务器；当 <code>connect=replicaSet</code> 时会发送所有的写请求到主并且把读请求分布在其他从服务器</li><li><code>false</code>: 表示无从服务器，当 <code>connect=direct</code> 时会自动找寻主服务器；当 <code>connect=replicaSet</code> 时仅连接主服务器，并且所有的读写命令都连接到主服务器</li></ul></li><li><code>safe=true|false</code>: 设置为 <code>true</code> 时，在执行更新操作之后，驱动都会发送 <code>getLastError</code> 命令来确保更新成功</li><li><code>w=n</code>: 驱动添加 <code>{w: n}</code> 到 <code>getLastError</code> 命令，应用于 <code>safe=true</code></li><li><code>wtimeoutMS=ms</code>: 驱动添加 <code>{wtimeout: ms}</code> 到 <code>getLastError</code> 命令，应用于 <code>safe=true</code></li><li><code>fsync=true|false</code>: 驱动添加 <code>{fsync: true}</code> 到 <code>getLastError</code> 命令，应用于 <code>safe=true</code></li><li><code>journal=true|false</code>: 如果设置为 <code>true</code>，同步到日志（在提交到数据库前写入到实体中），应用于 <code>safe=true</code></li><li><code>connectTimeoutMS=ms</code>: 可以打开连接的时间</li><li><code>socketTimeoutMS=ms</code>: 发送和接受 socket 的时间</li></ul><h3 id=连接命令格式>连接命令格式</h3><p>使用 mongosh 连接 MongoDB 时，也支持命令选项的方式添加配置：</p><ul><li><code>--host arg</code>: 指定数据库地址</li><li><code>--port arg</code>: 指定数据库端口</li><li><code>-u [ --username ] arg</code>: 鉴权的账号</li><li><code>-p [ --password ] arg</code>: 鉴权的密码</li></ul><h2 id=插入文档>插入文档</h2><h3 id=插入校验>插入校验</h3><p>MongoDB 会对要插入的数据进行最基本的检查：检查文档的基本结构，如缺少 <code>_id</code> 键会自动添加一个、是否包含非 UTF-8 字符、是否使用了无法识别的类型、检查文档大小等。</p><p>其中，检查文档大小主要因为 MongoDB 限制了所有文档必须小于 16MB，主要是为了防止不良的模式设计并确保性能上的一致。</p><p>要查看文档的 BSON 大小，可以在 shell 中执行 <code>Object.bsonsize(doc)</code> 查看字节大小。</p><h3 id=单个插入>单个插入</h3><p>官方文档：<a href=https://docs.mongodb.com/manual/reference/method/db.collection.insertOne/ target=_blank rel="noopener noreffer">db.collection.insertOne() — MongoDB Manual</a></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nx>collection</span><span class=p>.</span><span class=nx>insertOne</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=o>&lt;</span><span class=nb>document</span><span class=o>&gt;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>writeConcern</span><span class=o>:</span> <span class=o>&lt;</span><span class=nb>document</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=批量插入>批量插入</h3><p>官方文档：<a href=https://docs.mongodb.com/manual/reference/method/db.collection.insertMany/ target=_blank rel="noopener noreffer">db.collection.insertMany() — MongoDB Manual</a></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nx>collection</span><span class=p>.</span><span class=nx>insertMany</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span> <span class=o>&lt;</span><span class=nb>document</span> <span class=mi>1</span><span class=o>&gt;</span> <span class=p>,</span> <span class=o>&lt;</span><span class=nb>document</span> <span class=mi>2</span><span class=o>&gt;</span><span class=p>,</span> <span class=p>...</span> <span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>writeConcern</span><span class=o>:</span> <span class=o>&lt;</span><span class=nb>document</span><span class=o>&gt;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>ordered</span><span class=o>:</span> <span class=o>&lt;</span><span class=kr>boolean</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl>     <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>通过传输 <code>ordered=true</code> 可以确保文档按提供的顺序插入，指定为 <code>false</code> 则允许 MongoDB 重新排列插入的顺序以提高性能，默认为 <code>true</code> 值。</p><p>以有序插入的方式使用 <code>insertMany</code> 出现错误将会阻塞后续的插入动作，无需插入的方式则不管其他插入是否出现了错误。</p><h2 id=删除文档>删除文档</h2><h3 id=单个删除>单个删除</h3><p>官方文档：<a href=https://docs.mongodb.com/manual/reference/method/db.collection.deleteOne/ target=_blank rel="noopener noreffer">db.collection.deleteOne() — MongoDB Manual</a></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nx>collection</span><span class=p>.</span><span class=nx>deleteOne</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=o>&lt;</span><span class=nx>filter</span><span class=o>&gt;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>         <span class=nx>writeConcern</span><span class=o>:</span> <span class=o>&lt;</span><span class=nb>document</span><span class=o>&gt;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>         <span class=nx>collation</span><span class=o>:</span> <span class=o>&lt;</span><span class=nb>document</span><span class=o>&gt;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>         <span class=nx>hint</span><span class=o>:</span> <span class=o>&lt;</span><span class=nb>document</span><span class=o>|</span><span class=nx>string</span><span class=o>&gt;</span>    <span class=c1>// Available starting in MongoDB 4.4
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>使用 <code>hint</code> 参数可以指定 <code>filter</code> 查询时命中的索引，这对于复杂的索引结构时可以提升部分效率。</p><h3 id=批量删除>批量删除</h3><p>官方文档：<a href=https://docs.mongodb.com/manual/reference/method/db.collection.deleteMany/ target=_blank rel="noopener noreffer">db.collection.deleteMany() — MongoDB Manual</a></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nx>collection</span><span class=p>.</span><span class=nx>deleteMany</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=o>&lt;</span><span class=nx>filter</span><span class=o>&gt;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>         <span class=nx>writeConcern</span><span class=o>:</span> <span class=o>&lt;</span><span class=nb>document</span><span class=o>&gt;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>         <span class=nx>collation</span><span class=o>:</span> <span class=o>&lt;</span><span class=nb>document</span><span class=o>&gt;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>         <span class=nx>hint</span><span class=o>:</span> <span class=o>&lt;</span><span class=nb>document</span><span class=o>|</span><span class=nx>string</span><span class=o>&gt;</span>    <span class=c1>// Available starting in MongoDB 4.4
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=单个删除并返回>单个删除并返回</h3><p>官方文档：<a href=https://docs.mongodb.com/manual/reference/method/db.collection.findOneAndDelete/ target=_blank rel="noopener noreffer">db.collection.findOneAndDelete() — MongoDB Manual</a></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nx>collection</span><span class=p>.</span><span class=nx>findOneAndDelete</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=o>&lt;</span><span class=nx>filter</span><span class=o>&gt;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>writeConcern</span><span class=o>:</span> <span class=o>&lt;</span><span class=nb>document</span><span class=o>&gt;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>projection</span><span class=o>:</span> <span class=o>&lt;</span><span class=nb>document</span><span class=o>&gt;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>sort</span><span class=o>:</span> <span class=o>&lt;</span><span class=nb>document</span><span class=o>&gt;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>maxTimeMS</span><span class=o>:</span> <span class=o>&lt;</span><span class=nx>number</span><span class=o>&gt;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>collation</span><span class=o>:</span> <span class=o>&lt;</span><span class=nb>document</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=更新文档>更新文档</h2><p>更新文档是原子操作：如果两个更新同时发生，那么首先到达服务器的更新会先被执行，然后再执行下一个更新。</p><p>因此，相互冲突的更新可以安全地迅速接连完成，而不会破坏任何文档：最后一次更新将“成功”。如果不想使用默认行为，则可以考虑使用文档版本控制模式。</p><h3 id=单个更新>单个更新</h3><p>官方文档：<a href=https://docs.mongodb.com/manual/reference/method/db.collection.updateOne/ target=_blank rel="noopener noreffer">db.collection.updateOne() — MongoDB Manual</a></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nx>collection</span><span class=p>.</span><span class=nx>updateOne</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=o>&lt;</span><span class=nx>filter</span><span class=o>&gt;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=o>&lt;</span><span class=nx>update</span><span class=o>&gt;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>upsert</span><span class=o>:</span> <span class=o>&lt;</span><span class=kr>boolean</span><span class=o>&gt;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>writeConcern</span><span class=o>:</span> <span class=o>&lt;</span><span class=nb>document</span><span class=o>&gt;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>collation</span><span class=o>:</span> <span class=o>&lt;</span><span class=nb>document</span><span class=o>&gt;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>arrayFilters</span><span class=o>:</span> <span class=p>[</span> <span class=o>&lt;</span><span class=nx>filterdocument1</span><span class=o>&gt;</span><span class=p>,</span> <span class=p>...</span> <span class=p>],</span>
</span></span><span class=line><span class=cl>        <span class=nx>hint</span><span class=o>:</span>  <span class=o>&lt;</span><span class=nb>document</span><span class=o>|</span><span class=nx>string</span><span class=o>&gt;</span>    <span class=c1>// Available starting in MongoDB 4.2.1
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>在更新文档的时候，比较需要注意的事 <code>upsert</code> 的使用，其是一种特殊类型的更新：如果找不到与筛选条件相匹配的文档，则会以这个条件和更新文档为基础来创建一个新文档；如果找到了匹配的文档，则进行正常的更新。</p><p>因此，使用 <code>upsert</code> 的好处就是，可以使用同一套代码创建和更新文档。</p><p>使用 <code>upsert</code> 时就涉及到一个 <code>$setOnInsert</code> 运算符，它的作用是，只会在插入文档时设置字段的值，在后续的更新时不对其进行更改。</p><h3 id=批量更新>批量更新</h3><p>官方文档：<a href=https://docs.mongodb.com/manual/reference/method/db.collection.updateMany/ target=_blank rel="noopener noreffer">db.collection.updateMany() — MongoDB Manual</a></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nx>collection</span><span class=p>.</span><span class=nx>updateMany</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=o>&lt;</span><span class=nx>filter</span><span class=o>&gt;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=o>&lt;</span><span class=nx>update</span><span class=o>&gt;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>upsert</span><span class=o>:</span> <span class=o>&lt;</span><span class=kr>boolean</span><span class=o>&gt;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>writeConcern</span><span class=o>:</span> <span class=o>&lt;</span><span class=nb>document</span><span class=o>&gt;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>collation</span><span class=o>:</span> <span class=o>&lt;</span><span class=nb>document</span><span class=o>&gt;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>arrayFilters</span><span class=o>:</span> <span class=p>[</span> <span class=o>&lt;</span><span class=nx>filterdocument1</span><span class=o>&gt;</span><span class=p>,</span> <span class=p>...</span> <span class=p>],</span>
</span></span><span class=line><span class=cl>        <span class=nx>hint</span><span class=o>:</span>  <span class=o>&lt;</span><span class=nb>document</span><span class=o>|</span><span class=nx>string</span><span class=o>&gt;</span>    <span class=c1>// Available starting in MongoDB 4.2.1
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=单个替换>单个替换</h3><p>官方文档：<a href=https://www.mongodb.com/docs/manual/reference/method/db.collection.replaceOne/ target=_blank rel="noopener noreffer">db.collection.replaceOne() — MongoDB Manual</a></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nx>collection</span><span class=p>.</span><span class=nx>replaceOne</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=o>&lt;</span><span class=nx>filter</span><span class=o>&gt;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=o>&lt;</span><span class=nx>replacement</span><span class=o>&gt;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>upsert</span><span class=o>:</span> <span class=o>&lt;</span><span class=kr>boolean</span><span class=o>&gt;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>writeConcern</span><span class=o>:</span> <span class=o>&lt;</span><span class=nb>document</span><span class=o>&gt;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>collation</span><span class=o>:</span> <span class=o>&lt;</span><span class=nb>document</span><span class=o>&gt;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>hint</span><span class=o>:</span> <span class=o>&lt;</span><span class=nb>document</span><span class=o>|</span><span class=nx>string</span><span class=o>&gt;</span>     <span class=c1>// Available starting in 4.2.1
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p><code>replaceOne</code> 和 <code>updateOne</code> 操作的区别在于，<code>updateOne</code> 可以更新文档中部分键的值，而 <code>replaceOne</code> 的作用是直接将整个文档都替换掉，通常是建议使用 <code>updateOne</code> 而不是 <code>replaceOne</code>。</p><h3 id=单个更新并返回>单个更新并返回</h3><p>官方文档：<a href=https://docs.mongodb.com/manual/reference/method/db.collection.findOneAndUpdate/ target=_blank rel="noopener noreffer">db.collection.findOneAndUpdate() — MongoDB Manual</a></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nx>collection</span><span class=p>.</span><span class=nx>findOneAndUpdate</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=o>&lt;</span><span class=nx>filter</span><span class=o>&gt;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=o>&lt;</span><span class=nx>update</span> <span class=nb>document</span> <span class=nx>or</span> <span class=nx>aggregation</span> <span class=nx>pipeline</span><span class=o>&gt;</span><span class=p>,</span>  <span class=c1>// Changed in MongoDB 4.2
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>projection</span><span class=o>:</span> <span class=o>&lt;</span><span class=nb>document</span><span class=o>&gt;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>sort</span><span class=o>:</span> <span class=o>&lt;</span><span class=nb>document</span><span class=o>&gt;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>maxTimeMS</span><span class=o>:</span> <span class=o>&lt;</span><span class=nx>number</span><span class=o>&gt;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>upsert</span><span class=o>:</span> <span class=o>&lt;</span><span class=kr>boolean</span><span class=o>&gt;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>returnDocument</span><span class=o>:</span> <span class=o>&lt;</span><span class=nx>string</span><span class=o>&gt;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>returnNewDocument</span><span class=o>:</span> <span class=o>&lt;</span><span class=kr>boolean</span><span class=o>&gt;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>collation</span><span class=o>:</span> <span class=o>&lt;</span><span class=nb>document</span><span class=o>&gt;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>arrayFilters</span><span class=o>:</span> <span class=p>[</span> <span class=o>&lt;</span><span class=nx>filterdocument1</span><span class=o>&gt;</span><span class=p>,</span> <span class=p>...</span> <span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>使用 <code>findOneAndUpdate</code> 而不是 <code>updateOne</code> 的最大目的莫过于使用 <code>findOneAndUpdate</code> 可以返回更新前后文档内容。</p><p>通过设置 <code>returnNewDocument</code> 的值为 <code>true</code> 可以返回更新后的文档，为 <code>false</code> 时可以返回更新前的文档。</p><h3 id=单个替换并返回>单个替换并返回</h3><p>官方文档：<a href=https://docs.mongodb.com/manual/reference/method/db.collection.findOneAndReplace/ target=_blank rel="noopener noreffer">db.collection.findOneAndReplace() — MongoDB Manual</a></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nx>collection</span><span class=p>.</span><span class=nx>findOneAndReplace</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=o>&lt;</span><span class=nx>filter</span><span class=o>&gt;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=o>&lt;</span><span class=nx>replacement</span><span class=o>&gt;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>projection</span><span class=o>:</span> <span class=o>&lt;</span><span class=nb>document</span><span class=o>&gt;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>sort</span><span class=o>:</span> <span class=o>&lt;</span><span class=nb>document</span><span class=o>&gt;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>maxTimeMS</span><span class=o>:</span> <span class=o>&lt;</span><span class=nx>number</span><span class=o>&gt;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>upsert</span><span class=o>:</span> <span class=o>&lt;</span><span class=kr>boolean</span><span class=o>&gt;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>returnDocument</span><span class=o>:</span> <span class=o>&lt;</span><span class=nx>string</span><span class=o>&gt;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>returnNewDocument</span><span class=o>:</span> <span class=o>&lt;</span><span class=kr>boolean</span><span class=o>&gt;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>collation</span><span class=o>:</span> <span class=o>&lt;</span><span class=nb>document</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=更新运算符>更新运算符</h3><p>官方文档：<a href=https://docs.mongodb.com/manual/reference/operator/update/ target=_blank rel="noopener noreffer">Update Operators — MongoDB Manual</a></p><p>对于如 <code>updateOne</code>、<code>updateMany</code>、<code>findOneAndUpdate</code> 等更新操作，MongoDB 提供了原子的更新运算符支持只更新部分数据。</p><p>运算符支持以 <code>{ &lt;operator>: { &lt;field>: &lt;value>,... } }</code> 的方式使用，并且可以同时使用多个运算符。</p><p>为避免出现歧义，不建议对同一个属性同时使用不同的运算符。</p><h4 id=字段>字段</h4><ul><li><code>$currentDate</code>: 将指定键设置为当前时间</li><li><code>$inc</code>: 对数字类型的键做递增操作</li><li><code>$min</code>: 会比较原始值和更新值，并设置成较小值</li><li><code>$max</code>: 会比较原始值和更新值，并设置成较大值</li><li><code>$mul</code>: 对数字类型的键做乘法操作</li><li><code>$rename</code>: 修改指定键的名称</li><li><code>$set</code>: 将指定键设置为指定值</li><li><code>$setOnInsert</code>: 与 <code>upsert</code> 配合使用，如果更新导致文档插入，则设置字段的值，对修改现有文档的更新操作无效</li><li><code>$unset</code>: 删除指定键</li></ul><h4 id=数组>数组</h4><ul><li><code>$</code>: 充当占位符，更新与查询条件匹配的第一个元素</li><li><code>$[]</code>: 充当占位符，为匹配查询条件的文档更新数组中的所有元素</li><li><code>$[&lt;identifier>]</code>: 充当占位符，为匹配查询条件的文档更新与 <code>arrayFilters</code> 条件匹配的所有元素</li><li><code>$addToSet</code>: 仅当集合中不存在该元素时，才将元素添加到数组中</li><li><code>$pop</code>: 传 <code>{ $pop: { field: 1 } }</code> 表示删除数组中的最后一项，传 <code>-1</code> 时表示删除第一项</li><li><code>$pull</code>: 删除与指定查询匹配的所有数组元素</li><li><code>$push</code>: 新增一项到数组中</li><li><code>$pullAll</code>: 删除列出的所有数组元素</li></ul><h4 id=数组内层>数组内层</h4><ul><li><code>$each</code>: 使用 <code>$push</code> 或 <code>$addToSet</code> 运算符时，增加此运算符可以批量添加元素</li><li><code>$position</code>: 与 <code>$each</code> 配合使用，可以指定添加元素的位置</li><li><code>$slice</code>: 与 <code>$each</code> 配合使用，防止数组的增长超过某个大小，传正数表示从左到右截断</li><li><code>$sort</code>: 与 <code>$each</code> 配合使用，对添加完元素的数组进行排序</li></ul><h4 id=位运算>位运算</h4><p><code>$bit</code>: 支持对整数值进行按位 <code>AND</code>、<code>OR</code> 或 <code>XOR</code> 更新，通过使用 <code>{ $bit: { &lt;field>: { &lt;and|or|xor>: &lt;int> } } }</code> 完成更新。</p><h2 id=批量写操作>批量写操作</h2><p>官方文档：<a href=https://docs.mongodb.com/manual/reference/method/db.collection.bulkWrite/ target=_blank rel="noopener noreffer">db.collection.bulkWrite() — MongoDB Manual</a></p><p>MongoDB 提供了 <code>bulkwrite</code> 命令支持批量执行命令，批处理时在一定程度上减少了网络交互的损耗。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nx>collection</span><span class=p>.</span><span class=nx>bulkWrite</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span> <span class=o>&lt;</span><span class=nx>operation</span> <span class=mi>1</span><span class=o>&gt;</span><span class=p>,</span> <span class=o>&lt;</span><span class=nx>operation</span> <span class=mi>2</span><span class=o>&gt;</span><span class=p>,</span> <span class=p>...</span> <span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>         <span class=nx>writeConcern</span><span class=o>:</span> <span class=o>&lt;</span><span class=nb>document</span><span class=o>&gt;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>         <span class=nx>ordered</span><span class=o>:</span> <span class=o>&lt;</span><span class=kr>boolean</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>支持的以下操作：</p><ul><li><code>insertOne</code></li><li><code>updateOne</code></li><li><code>updateMany</code></li><li><code>replaceOne</code></li><li><code>deleteOne</code></li><li><code>deleteMany</code></li></ul><h2 id=查询文档>查询文档</h2><h3 id=单个查询>单个查询</h3><p>官方文档：<a href=https://docs.mongodb.com/manual/reference/method/db.collection.findOne/ target=_blank rel="noopener noreffer">db.collection.findOne() — MongoDB Manual</a></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nx>collection</span><span class=p>.</span><span class=nx>findOne</span><span class=p>(</span><span class=nx>query</span><span class=p>,</span> <span class=nx>projection</span><span class=p>,</span> <span class=nx>options</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>第一个参数是查询条件，可以使用键值对的方式指定需要匹配的条件，多个键之间是 <code>AND</code> 的关系。</p><p>第二个参数用于仅返回指定的键，既可以节省网络传输的数据量，也可以减少客户端解码文档的时间和内存消耗。</p><p>第三个参数可以指定查询到可选项，这些选项会修改查询行为和返回结果的方式。更多查看 <a href=https://mongodb.github.io/node-mongodb-native/4.0//interfaces/findoptions.html target=_blank rel="noopener noreffer">官方文档</a>。</p><h3 id=批量查询>批量查询</h3><p>官方文档：<a href=https://docs.mongodb.com/manual/reference/method/db.collection.find/ target=_blank rel="noopener noreffer">db.collection.find() — MongoDB Manual</a></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nx>collection</span><span class=p>.</span><span class=nx>find</span><span class=p>(</span><span class=nx>query</span><span class=p>,</span> <span class=nx>projection</span><span class=p>,</span> <span class=nx>options</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>数据库会使用游标返回 <code>find</code> 的执行结果。</p><p>对于游标，客户端可以限制结果的数量，跳过一些结果，按任意方向的任意键组合对结果进行排序等操作。更多查询 <a href=https://www.mongodb.com/docs/manual/reference/method/db.collection.find/#available-mongosh-cursor-methods target=_blank rel="noopener noreffer">官方文档</a>。</p><p>下述是一些常用的游标方法：</p><ul><li><code>count()</code>: 统计游标引用的文档数量</li><li><code>hasNext()</code>: 查询是否有下一个结果</li><li><code>hint(index)</code>: 指定游标命中的索引</li><li><code>limit(number)</code>: 限制返回结果的数量</li><li><code>next()</code>: 返回下一个搜索结果</li><li><code>size()</code>: 返回应用 <code>skip()</code> 和 <code>limit()</code> 之后的查询数量</li><li><code>skip(number)</code>: 控制跳过一定的数量，跳过大量数据会比较慢</li><li><code>sort(sort)</code>: 使用键值对的方式对搜索结果进行排序</li></ul><p>在服务器端，游标会占用内存的资源。通常在以下情况会终止游标及进行随后的清理：</p><ul><li>当游标遍历完成匹配的结果时，它会清除自身</li><li>当游标超出客户端的作用域时，驱动程序会向数据库发送终止游标的信号</li><li>当游标达到 10 分钟没有使用时，数据库游标会被自动销毁</li></ul><h3 id=查询运算符>查询运算符</h3><p>官方文档：<a href=https://docs.mongodb.com/manual/reference/operator/query/ target=_blank rel="noopener noreffer">Query and Projection Operators — MongoDB Manual</a></p><p>同样的，设置查询条件时，MongoDB 提供了查询运算符支持更多的查询方式。</p><h4 id=比较运算符>比较运算符</h4><ul><li><code>$eq</code>: 返回等于指定值的结果，等同 <code>{ &lt;field>: &lt;value> }</code> 的显式表示</li><li><code>$gt</code>: 返回大于指定值的结果</li><li><code>$gte</code>: 返回大于等于指定值的结果</li><li><code>$in</code>: 返回等于指定数组中任意一个值的结果，对于一个键匹配多个值，<code>$in</code> 比 <code>$or</code> 更方便</li><li><code>$lt</code>: 返回小于指定值的结果</li><li><code>$lte</code>: 返回小于等于指定值的结果</li><li><code>$ne</code>: 返回不等于指定值的结果</li><li><code>$nin</code>: 返回不等于指定数组中任意一个值的结果</li></ul><h4 id=逻辑运算符>逻辑运算符</h4><ul><li><code>$and</code>: 返回同时符合查询子句要求的结果</li><li><code>$not</code>: 元运算符，匹配不符合查询语句要求的结果</li><li><code>$nor</code>: 返回不能同时符合查询子句要求的结果</li><li><code>$or</code>: 返回与任意一个查询子句的条件匹配的结果</li></ul><p>对于普通的 <code>$and</code> 类型查询，我们总是希望尽可能用最少的参数来限定结果的范围。而 <code>$or</code> 类型查询则相反，如果第一个参数能够匹配尽可能多的文档，则其效率最高。</p><h4 id=元素运算符>元素运算符</h4><ul><li><code>$exists</code>: 判断指定键是否存在，返回符合要求的结果</li><li><code>$type</code>: 判断指定键的数据类型，返回符合要求的结果（好的模式设计不应该出现不同类型）</li></ul><h4 id=表达式运算符>表达式运算符</h4><ul><li><code>$expr</code>: 允许使用聚合表达式，适合用在一些比较复杂的查询语句</li><li><code>$jsonSchema</code>: 根据给定的 JSON 模式验证文档，返回符合要求的结果</li><li><code>$mod</code>: 指定键的值执行模运算，返回符合要求的结果</li><li><code>$regex</code>: 使用正则表达式对指定键做匹配，MongoDB 可以利用索引来查询前缀正则表达式，但不能用于不区分大小写的搜索</li><li><code>$text</code>: 对使用文本索引的字段内容执行文本搜索，可以作为一个简易的搜索引擎使用</li><li><code>$where</code>: 允许在查询时执行任意 JavaScript 代码（性能较差，尽可能使用 <code>$expr</code> 代替）</li></ul><h4 id=数组运算符>数组运算符</h4><ul><li><code>$all</code>: 匹配包含查询中指定的所有元素的数组</li><li><code>$elemMatch</code>: 用于强制将查询子句与单个数组元素进行匹配</li><li><code>$size</code>: 匹配指定数组长度大小的结果</li></ul><h4 id=投影运算符>投影运算符</h4><p>投影运算符针对的是查询语句的第二个参数，即返回的结果。</p><ul><li><code>$</code>: 仅返回数组中与查询条件匹配的第一个元素</li><li><code>$elemMatch</code>: 对返回结果中的数组元素做 <code>$elemMatch</code> 匹配，仅返回数组中满足要求的元素</li><li><code>$meta</code>: 与 <code>$text</code> 运算符配合使用，返回与文档关联的元数据，可以返回匹配分数，或者索引键</li><li><code>$slice</code>: 对返回结果中的数组做截取返回</li></ul><h3 id=特殊的-null-值>特殊的 null 值</h3><p>在 MongoDB 中，<code>null</code> 是一个比较特殊的值，它可以与自身匹配。也就是说了，通过 <code>{ field: null }</code> 可以查询出 <code>field</code> 键为 <code>null</code> 的文档。</p><p>不过，更特殊的是，<code>null</code> 同样会匹配缺少这个键值的文档。也就是说，<code>{ field: null }</code> 可以查询出不包含 <code>field</code> 键的文档。</p><p>如果仅想匹配键值为 <code>null</code> 的文档，则需要检查该键的值是否为 <code>null</code>，并且通过 <code>$exists</code> 条件确认该键已存在，如 <code>{ field: { $eq: null, $exists: true } }</code> 就是这样的查询条件组。</p></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>更新于 2023-01-31</span></div></div><div class=post-info-line><div class=post-info-md><span><a class=link-to-markdown href=/posts/database/mongodb-crud.md target=_blank>阅读原始文档</a></span></div><div class=post-info-share><span></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw" aria-hidden=true></i>&nbsp;<a href=/tags/nosql.html>NoSQL</a>,&nbsp;<a href=/tags/mongodb.html>MongoDB</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>返回</a></span>&nbsp;|&nbsp;<span><a href=/>主页</a></span></section></div><div class=post-nav><a href=/posts/database/mongodb-started-guide.html class=prev rel=prev title="MongoDB - 入门指南"><i class="fas fa-angle-left fa-fw" aria-hidden=true></i>MongoDB - 入门指南</a>
<a href=/posts/database/mongodb-index-knowledge.html class=next rel=next title="MongoDB - 索引知识">MongoDB - 索引知识<i class="fas fa-angle-right fa-fw" aria-hidden=true></i></a></div></div><div id=comments><div id=giscus class=comment></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://giscus.app>Giscus</a>.</noscript></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>由 <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.110.0">Hugo</a> 强力驱动 | 主题 - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="noopener noreffer" title="LoveIt 0.2.11"><i class="far fa-kiss-wink-heart fa-fw" aria-hidden=true></i> LoveIt</a></div><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><i class="far fa-copyright fa-fw" aria-hidden=true></i><span itemprop=copyrightYear>2022 - 2023</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank>翔仔</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span><span class=icp-splitter>&nbsp;|&nbsp;</span><br class=icp-br><span class=icp><a href=https://beian.miit.gov.cn/ target=_blank>粤ICP备2021076569号</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title=回到顶部><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a href=# id=view-comments class=fixed-button title=查看评论><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.css><script type=text/javascript src=https://cdn.jsdelivr.net/npm/autocomplete.js@0.38.1/dist/autocomplete.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lunr@2.3.9/lunr.min.js></script><script type=text/javascript src=/lib/lunr/lunr.stemmer.support.min.7b0408f98c705b0bc4a799d0202fa56eb3205ac5921eabd9361c0b6788f342f09cb993017c67db1e9a9cc94773fbd5719a10c007bda24312630eb81919b8b8a1.js integrity="sha512-ewQI+YxwWwvEp5nQIC+lbrMgWsWSHqvZNhwLZ4jzQvCcuZMBfGfbHpqcyUdz+9VxmhDAB72iQxJjDrgZGbi4oQ=="></script><script type=text/javascript src=/lib/lunr/lunr.zh.min.918bdd059e2c518e24c32fb5fd89144a49778f21f2166db93bf1e2ed311b3589660feb5777210257aee209f6d8bdde8c296883e34ff8bf4d5338f4be53132976.js integrity="sha512-kYvdBZ4sUY4kwy+1/YkUSkl3jyHyFm25O/Hi7TEbNYlmD+tXdyECV67iCfbYvd6MKWiD40/4v01TOPS+UxMpdg=="></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/auto-render.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/copy-tex.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/mhchem.min.js></script><script type=text/javascript src=/js/baidu_tongji.b0e0519286d388eaa2ec7550b8dbb0df7488e085ea2e108bbd48ca6171b7696797554da5cdf808f754e5dae27659b75d83402926da5821c7ae2409445a7b488e.js integrity="sha512-sOBRkobTiOqi7HVQuNuw33SI4IXqLhCLvUjKYXG3aWeXVU2lzfgI91Tl2uJ2Wbddg0ApJtpYIceuJAlEWntIjg=="></script><script type=text/javascript>window.config={code:{copyTitle:"复制到剪贴板",maxShownLines:50},comment:{giscus:{category:"Announcements",categoryId:"DIC_kwDOIa-wYs4CSg4a",darkTheme:"dark",emitMetadata:"0",inputPosition:"top",lang:"zh-CN",lazyLoading:!0,lightTheme:"light",mapping:"pathname",reactionsEnabled:"1",repo:"fatedeity/blog-comment",repoId:"R_kgDOIa-wYg"}},math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!0,left:"\\begin{equation}",right:"\\end{equation}"},{display:!0,left:"\\begin{equation*}",right:"\\end{equation*}"},{display:!0,left:"\\begin{align}",right:"\\end{align}"},{display:!0,left:"\\begin{align*}",right:"\\end{align*}"},{display:!0,left:"\\begin{alignat}",right:"\\end{alignat}"},{display:!0,left:"\\begin{alignat*}",right:"\\end{alignat*}"},{display:!0,left:"\\begin{gather}",right:"\\end{gather}"},{display:!0,left:"\\begin{CD}",right:"\\end{CD}"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},search:{highlightTag:"em",lunrIndexURL:"/index.json",lunrLanguageCode:"zh",lunrSegmentitURL:"/lib/lunr/lunr.segmentit.js",maxResultLength:10,noResultsFound:"没有找到结果",snippetLength:50,type:"lunr"}}</script><script type=text/javascript src=/js/theme.min.2970a33d719df7cd89cebf586152b32a8ed30012227fa81b44282950146e0f595d1c733779e4d423dda1004bdcf707ee64d0fadc3d21229cd66b960788f84bdb.js integrity="sha512-KXCjPXGd982Jzr9YYVKzKo7TABIif6gbRCgpUBRuD1ldHHM3eeTUI92hAEvc9wfuZND63D0hIpzWa5YHiPhL2w=="></script></body></html>